# 卡券服务上线手册

v 0.0.1

by 欧莱雅IT

## 修订历史

| 版本  | 修订说明       | 提交人   | 生效日期 |
| ----- | -------------- | -------- | -------- |
| 0.0.1 | 初始化创建文档 | Larry Yu |          |
|       |                |          |          |

[TOC]



## 引言

### 目的

卡券服务上线将会有一系列步骤需要操作，比如部署，配置，集成测试，线上运营维护等。

为方便相关人员理解系统以及如何操作，本文档介绍如何上线部署卡券服务，如何配置卡券服务以及卡券服务。

卡券服务依赖用户认证服务，关于用户认证服务部署以及线上运营，请参阅 **authorization server handbook**

【**注意：卡券服务仍在第一次开发中，内容可能会有变动。**】

### 限制

目前尚未有CI/CD 等一系列自动化的基础架构服务，基本需要手动工作。

## 开发

### 代码

## 编译

编译环境需要配置好Centos Golang1.13环境，用来编译可执行程序，**但在目标机器执行没有包含db升级脚本，有点奇怪。**



。。。

## 部署

### 安装oAuth2软件

根据 https://www.cnblogs.com/atcloud/p/10564479.html 离线安装docker。

docker save mysql，keycloak, docker load mysql, keycloak.

或者通过 https://hub.docker.com/r/jboss/keycloak 全新安装。

【注意】全新部署时，注意初始化管理员账号。

### 安装卡券服务

目前是在某个docker 容器内build好，复制到目标服务器。

### 访问配置

- 因为需要对公服务，所以需要配置对公访问路由（反向代理）。

- 因为需要访问用户认证服务，需要确认卡券服务能够访问用户认证服务。


### 服务配置

#### 卡券配置文件

目前运行期间需要的配置文件为config.json。【未来需要考虑如何管理不同环境的配置文件，类似K8S放在源代码？】

| 配置项      | SIT                              | PROD |
| ----------- | -------------------------------- | ---- |
| address     | :8081                            |      |
| jwt-key     | a9ac231b0f2a4f448b8846fd1f57814a |      |
| auth-pubkey | 查看各个环节的oauth服务          |      |



注意： **SIT环境的端口是8081**.

部署成功后，使用 /health 测试是否OK.

#### oAuth2服务配置

可以从现成的服务导出realm，比如测试环境的realm。

目前的realm的名字是Lorealcn.

更新realm的public key到 卡券服务的配置文件。重启卡券服务。

## 上线前字典配置

上线前需要配置的有

| 字典          | 备注                                   |      |
| ------------- | -------------------------------------- | ---- |
| 品牌（Group） | 业务上配置品牌需要                     |      |
| 客户端        | 第三方开发者的应用接入需要             |      |
| 角色          | 不同角色在卡券服务中具有不同的行为权限 |      |
| 用户          | 访问卡券服务的用户                     |      |

这里准备了一些表单用来给相关方提交申请，然后配置字典。 https://loreal-my.sharepoint.com/:f:/p/larry_yu2/EkO7tpU8l7xPtcnlPuorxJUBnNHT8NwmrV2eIJR-rN4Kuw （Dennis已经有了这些模板）

注意：关于如何在认证服务中配置，请参阅authorization server handbook。



























